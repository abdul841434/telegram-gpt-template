name: Deploy to Yandex Cloud

on:
  push:
    branches:
      - main

env:
  REGISTRY: cr.yandex
  IMAGE_NAME: empathy-bot

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run linter
        run: ruff check .
      
      - name: Run tests
        run: pytest tests/ -v --tb=short
      
      - name: Validate JSON configs
        run: |
          python -c "import json; json.load(open('config/prompts.json'))"
          python -c "import json; json.load(open('config/messages.json'))"

  build-and-push:
    name: Build and Push Docker Image
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Yandex Container Registry
        run: |
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º JSON –∫–ª—é—á –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
          echo '${{ secrets.YC_SA_JSON_CREDENTIALS }}' > /tmp/key.json
          
          # –õ–æ–≥–∏–Ω–∏–º—Å—è –∏—Å–ø–æ–ª—å–∑—É—è docker –∏ yc CLI
          cat /tmp/key.json | docker login \
            --username json_key \
            --password-stdin \
            cr.yandex/${{ secrets.YC_REGISTRY_ID }}
          
          # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
          rm /tmp/key.json
      
      - name: Build and push Docker image
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}"
          
          # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑
          docker build -t ${IMAGE_TAG}:latest -t ${IMAGE_TAG}:${{ github.sha }} .
          
          # –ü—É—à–∏–º –æ–±–∞ —Ç–µ–≥–∞
          docker push ${IMAGE_TAG}:latest
          docker push ${IMAGE_TAG}:${{ github.sha }}

  deploy:
    name: Deploy to Server
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          LLM_TOKEN: ${{ secrets.LLM_TOKEN }}
          DEBUG_CHAT: ${{ secrets.DEBUG_CHAT }}
          MODEL: ${{ secrets.MODEL || 'google/gemini-2.0-flash-exp:free' }}
          DEBUG: ${{ secrets.DEBUG || '0' }}
          TABLE_NAME: ${{ secrets.TABLE_NAME || 'users' }}
          MAX_CONTEXT: ${{ secrets.MAX_CONTEXT || '20' }}
          MAX_STORAGE: ${{ secrets.MAX_STORAGE || '100' }}
          DELAYED_REMINDERS_HOURS: ${{ secrets.DELAYED_REMINDERS_HOURS || '2' }}
          DELAYED_REMINDERS_MINUTES: ${{ secrets.DELAYED_REMINDERS_MINUTES || '0' }}
          TIMEZONE_OFFSET: ${{ secrets.TIMEZONE_OFFSET || '3' }}
          FROM_TIME: ${{ secrets.FROM_TIME || '9' }}
          TO_TIME: ${{ secrets.TO_TIME || '23' }}
          ADMIN_LIST: ${{ secrets.ADMIN_LIST || '' }}
          FILE_LOG_LEVEL: ${{ secrets.FILE_LOG_LEVEL || 'INFO' }}
          TELEGRAM_LOG_LEVEL: ${{ secrets.TELEGRAM_LOG_LEVEL || 'DISABLED' }}
          NEW_IMAGE: ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest
          BACKUP_IMAGE: ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:stable
        with:
          host: ${{ secrets.YC_INSTANCE_IP }}
          username: ${{ secrets.YC_INSTANCE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: TG_TOKEN,LLM_TOKEN,DEBUG_CHAT,MODEL,DEBUG,TABLE_NAME,MAX_CONTEXT,MAX_STORAGE,DELAYED_REMINDERS_HOURS,DELAYED_REMINDERS_MINUTES,TIMEZONE_OFFSET,FROM_TIME,TO_TIME,ADMIN_LIST,FILE_LOG_LEVEL,TELEGRAM_LOG_LEVEL,NEW_IMAGE,BACKUP_IMAGE
          script: |
            set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            
            echo "üîÑ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π..."
            
            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            mkdir -p /opt/empathy-bot/data /opt/empathy-bot/logs
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Ä–∞–±–æ—Ç–∞—é—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
            CURRENT_IMAGE=""
            if docker ps --filter name=empathy-ai-bot --format "{{.Image}}" | grep -q .; then
              CURRENT_IMAGE=$(docker ps --filter name=empathy-ai-bot --format "{{.Image}}")
              echo "üì∏ –¢–µ–∫—É—â–∏–π –æ–±—Ä–∞–∑: $CURRENT_IMAGE"
              
              # –¢–µ–≥–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–π –æ–±—Ä–∞–∑ –∫–∞–∫ stable (—Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è)
              docker tag "$CURRENT_IMAGE" "$BACKUP_IMAGE" || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å backup —Ç–µ–≥"
            else
              echo "‚ö†Ô∏è  –¢–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"
            fi
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑
            echo "‚¨áÔ∏è  –°–∫–∞—á–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑..."
            docker pull "$NEW_IMAGE"
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            echo "‚è∏Ô∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
            docker stop empathy-ai-bot 2>/dev/null || true
            docker rm empathy-ai-bot 2>/dev/null || true
            
            # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            start_container() {
              local IMAGE=$1
              echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –æ–±—Ä–∞–∑–æ–º: $IMAGE"
              
              docker run -d \
                --name empathy-ai-bot \
                --restart unless-stopped \
                -e TG_TOKEN="$TG_TOKEN" \
                -e LLM_TOKEN="$LLM_TOKEN" \
                -e DEBUG_CHAT="$DEBUG_CHAT" \
                -e MODEL="$MODEL" \
                -e DEBUG="$DEBUG" \
                -e DATABASE_NAME=/data/users.db \
                -e TABLE_NAME="$TABLE_NAME" \
                -e MAX_CONTEXT="$MAX_CONTEXT" \
                -e MAX_STORAGE="$MAX_STORAGE" \
                -e DELAYED_REMINDERS_HOURS="$DELAYED_REMINDERS_HOURS" \
                -e DELAYED_REMINDERS_MINUTES="$DELAYED_REMINDERS_MINUTES" \
                -e TIMEZONE_OFFSET="$TIMEZONE_OFFSET" \
                -e FROM_TIME="$FROM_TIME" \
                -e TO_TIME="$TO_TIME" \
                -e ADMIN_LIST="$ADMIN_LIST" \
                -e FILE_LOG_LEVEL="$FILE_LOG_LEVEL" \
                -e TELEGRAM_LOG_LEVEL="$TELEGRAM_LOG_LEVEL" \
                -v /opt/empathy-bot/data:/data \
                -v /opt/empathy-bot/logs:/app/logs \
                "$IMAGE"
            }
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            if start_container "$NEW_IMAGE"; then
              echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω"
            else
              echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
              exit 1
            fi
            
            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –∏ –º–∏–≥—Ä–∞—Ü–∏–π
            echo "‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–ø—É—Å–∫–∞ (15 —Å–µ–∫—É–Ω–¥)..."
            sleep 15
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
            if docker ps --filter name=empathy-ai-bot --filter status=running | grep -q empathy-ai-bot; then
              echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç"
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
              if docker logs empathy-ai-bot 2>&1 | tail -50 | grep -iE "CRITICAL|ERROR.*Failed to|Exception.*startup"; then
                echo "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö!"
                
                # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
                if [ -n "$CURRENT_IMAGE" ]; then
                  echo "üîô –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏: $CURRENT_IMAGE"
                  docker stop empathy-ai-bot 2>/dev/null || true
                  docker rm empathy-ai-bot 2>/dev/null || true
                  start_container "$CURRENT_IMAGE"
                  sleep 10
                  echo "üîÑ –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
                  docker logs empathy-ai-bot --tail=30
                  exit 1
                else
                  echo "‚ö†Ô∏è  –ù–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –¥–ª—è –æ—Ç–∫–∞—Ç–∞!"
                  docker logs empathy-ai-bot --tail=50
                  exit 1
                fi
              else
                echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–µ–Ω!"
                docker logs empathy-ai-bot --tail=30
                echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
                docker ps --filter name=empathy-ai-bot
              fi
            else
              echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!"
              
              # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
              if [ -n "$CURRENT_IMAGE" ]; then
                echo "üîô –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏: $CURRENT_IMAGE"
                docker stop empathy-ai-bot 2>/dev/null || true
                docker rm empathy-ai-bot 2>/dev/null || true
                start_container "$CURRENT_IMAGE"
                sleep 10
                echo "üîÑ –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω"
                docker logs empathy-ai-bot --tail=30
              else
                echo "‚ö†Ô∏è  –ù–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –¥–ª—è –æ—Ç–∫–∞—Ç–∞!"
                docker logs empathy-ai-bot --tail=50
              fi
              exit 1
            fi
      
      - name: Final verification
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.YC_INSTANCE_IP }}
          username: ${{ secrets.YC_INSTANCE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."
            
            if docker ps --filter name=empathy-ai-bot --filter status=running | grep -q empathy-ai-bot; then
              echo "‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç"
              echo ""
              echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:"
              docker ps --filter name=empathy-ai-bot --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
              echo ""
              echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
              docker logs empathy-ai-bot --tail=20
            else
              echo "‚ùå –í–ù–ò–ú–ê–ù–ò–ï: –ë–æ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!"
              echo ""
              echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
              docker logs empathy-ai-bot --tail=50 2>&1 || echo "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
              exit 1
            fi
