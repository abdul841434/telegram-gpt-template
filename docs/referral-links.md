# Реферальные ссылки

## Описание

Бот поддерживает отслеживание реферальных ссылок для понимания, откуда приходят новые пользователи.

## Как это работает

### Создание реферальной ссылки

Реферальная ссылка имеет формат:
```
https://t.me/your_bot_name?start=REF_CODE
```

Где `REF_CODE` — это уникальный код, который вы хотите использовать для отслеживания источника.

### Примеры реферальных кодов

- `https://t.me/your_bot?start=instagram_post_123` — ссылка из поста в Instagram
- `https://t.me/your_bot?start=youtube_video_456` — ссылка из описания YouTube видео
- `https://t.me/your_bot?start=partner_john` — ссылка от партнера John
- `https://t.me/your_bot?start=ad_campaign_2025` — ссылка из рекламной кампании

## Сохранение данных

Когда пользователь переходит по реферальной ссылке:
1. Бот регистрирует пользователя
2. Сохраняет реферальный код в поле `referral_code` таблицы `conversations`
3. Записывает событие в лог: `USER{id}: переход по реф.ссылке, код: {code}`

## Просмотр статистики (только для администратора)

Администратор может просмотреть статистику по реферальным ссылкам с помощью команды:
```
/referral_stats
```

Команда покажет:
- Общее количество пользователей с реферальными кодами
- Список всех использованных кодов
- Количество пользователей по каждому коду

## Важные замечания

1. **Реферальный код сохраняется только при первой регистрации** — если пользователь уже зарегистрирован, код не обновится

2. **Старые пользователи** — у пользователей, зарегистрированных до внедрения этой функции, поле `referral_code` будет `NULL`

3. **Валидация кода** — реферальный код должен быть частью команды `/start`. Обычные сообщения не считаются реферальными ссылками

4. **Логирование** — все переходы по реферальным ссылкам записываются в лог-файл (`debug.log`) для аудита

## Технические детали

### Структура БД

Поле `referral_code` добавлено в таблицу `conversations`:
```sql
ALTER TABLE conversations ADD COLUMN referral_code TEXT DEFAULT NULL;
```

### Миграция

Миграция `migration_010_add_referral_code.py` автоматически добавляет поле при обновлении бота.

### Пример использования в коде

```python
# При регистрации пользователя
conversation = Conversation(
    user_id,
    name="User Name",
    referral_code="instagram_post_123"
)
await conversation.save_for_db()

# При получении информации о пользователе
conversation = Conversation(user_id)
await conversation.get_from_db()
print(f"Реферальный код: {conversation.referral_code}")
```

## Рекомендации по использованию реферальных кодов

1. **Используйте осмысленные имена**: вместо `ref1`, `ref2` используйте `instagram_2025_01`, `partner_alex`

2. **Добавляйте даты**: `youtube_2025_12_05` поможет отследить эффективность во времени

3. **Разделяйте по источникам**: `social_instagram`, `social_youtube`, `ad_google`, `partner_company`

4. **Используйте короткие коды для офлайн**: для печатных материалов — `QR001`, `PRINT_JAN25`

## Аналитика

С помощью логов и команды `/referral_stats` вы можете:
- Определить самые эффективные каналы привлечения
- Оценить ROI рекламных кампаний
- Отследить активность партнеров
- Понять, какой контент привлекает больше пользователей

