# Система напоминаний

## Обзор

Система напоминаний позволяет боту отправлять пользователям проактивные сообщения в заданное время.

## Как это работает

### Фоновая задача

- **Интервал проверки**: каждые 15 минут (вместо прежних 30 секунд)
- **Фоновая задача**: работает параллельно с основным ботом в отдельном asyncio task
- **Логика**: проверяет список пользователей и сравнивает текущее время (МСК) со списком времен напоминаний

### Типы напоминаний

Система использует **6 различных типов промптов** для разнообразия напоминаний. При каждой отправке выбирается случайный тип:

1. **interests** - Вопросы об интересах (что читает/смотрит)
2. **situational** - Ситуативные вопросы (как проходит понедельник/выходной)
3. **humor** - Юмор и интересные факты
4. **how_are_you** - Как дела, что нового
5. **compliment** - Комплименты и похвалы
6. **plans** - Вопросы о планах на будущее (на день, неделю, долгосрочные цели)

Каждый промпт учитывает:
- **Контекст** предыдущих разговоров
- **Текущую дату и время**
- **День недели** (для ситуативных промптов)
- **Имя пользователя** (если доступно)

### Время и дни недели напоминаний

Настройки напоминаний управляются через переменные окружения (глобально для всех пользователей):

- **`REMINDER_TIME`** - время напоминания в формате `HH:MM` (МСК). По умолчанию: `"19:15"`
- **`REMINDER_WEEKDAYS`** - дни недели через запятую (0=Понедельник, 6=Воскресенье). Пустое значение = все дни. Пример: `"0,1,2,3,4"` для будних дней
- **`REMINDER_CHECK_INTERVAL`** - интервал проверки напоминаний в секундах. По умолчанию: `900` (15 минут)

**Примечание**: Ранее каждый пользователь мог иметь индивидуальные настройки через команду `/set_reminder_times`, но эта функциональность была упрощена. Теперь все пользователи используют глобальные настройки из переменных окружения.

### Предотвращение дублей

Чтобы избежать отправки нескольких напоминаний в течение одного периода:
- После отправки напоминания обновляется поле `remind_of_yourself` на текущее время
- При проверке система проверяет, что последнее напоминание было отправлено более часа назад
- Если время напоминания попадает в окно 15 минут (0-14 минут после заданного времени)

## Админские команды

### `/send_reminders`

Принудительная отправка напоминаний всем пользователям, у которых НЕ отключены напоминания.

**Использование**:
- Просто отправьте команду `/send_reminders` в админ-чате
- Бот отправит напоминания всем пользователям с включенными напоминаниями
- Покажет статистику: успешно отправлено, заблокировавших бота, ошибки

**Примечание**: Обычно напоминания отправляются автоматически по расписанию. Эта команда позволяет отправить их немедленно.

## База данных

### Миграция

Миграция `migration_012_simplify_reminder_times.py` упрощает структуру напоминаний:
- Заменяет `reminder_times` (список времен) на `reminder_time` (одно время)
- Добавляет `reminder_weekdays` (список дней недели)
- При миграции берется первое время из старого списка
- **Применяется автоматически** при запуске бота

### Структура данных

**reminder_time**: `"19:15"` (строка в формате HH:MM)

**reminder_weekdays**: `[]` (пустой список = все дни) или `[0,1,2,3,4]` (будние дни)

## Отключение напоминаний

Чтобы отключить напоминания для пользователя:
- Установите поле `remind_of_yourself` в значение `"0"`
- Пользователь будет пропущен при проверке

## Логи

При отправке напоминания в логах появляется тип использованного промпта:
```
USER{user_id} - Выбран тип напоминания: situational
LLM{user_id}REMINDER_SITUATIONAL - {текст сообщения}
```

Другие типы в логах: `REMINDER_INTERESTS`, `REMINDER_HUMOR`, `REMINDER_HOW_ARE_YOU`, `REMINDER_COMPLIMENT`, `REMINDER_PLANS`

При обновлении времен напоминаний:
```
✅ Времена напоминаний для USER{user_id} обновлены: 09:00, 14:30, 19:15
```

## Пример работы

1. В переменных окружения установлено: `REMINDER_TIME="19:15"`, `REMINDER_WEEKDAYS=""` (все дни)
2. В 19:17 МСК фоновая задача проверяет пользователей (проверка каждые 15 минут)
3. Находит, что 19:15 попадает в окно (19:17 - 19:15 = 2 минуты < 15)
4. Проверяет, что текущий день недели подходит (или список пустой = все дни)
5. Проверяет, что последнее напоминание было > 1 часа назад
6. **Выбирает случайный тип напоминания** (например, "situational")
7. Формирует промпт с учетом дня недели ("Понедельник")
8. Отправляет запрос к LLM с выбранным промптом
9. Отправляет ответ модели пользователю
10. Обновляет `remind_of_yourself` на текущее время (19:17)

## Технические детали

### Файлы

- `migrations/migration_012_simplify_reminder_times.py` - миграция БД (упрощение структуры)
- `database.py` - класс Conversation с поддержкой `reminder_time` и `reminder_weekdays`
- `services/reminder_service.py` - фоновая задача и логика отправки
- `handlers/admin_handlers.py` - команда `/send_reminders`
- `config.py` - переменные окружения для настройки напоминаний

### Часовой пояс

Все времена работают в **МСК (UTC+3)**, настраивается через переменную окружения `TIMEZONE_OFFSET=3`.

