# Система напоминаний

## Обзор

Система напоминаний позволяет боту отправлять пользователям проактивные сообщения в заданное время.

## Как это работает

### Фоновая задача

- **Интервал проверки**: каждые 15 минут (вместо прежних 30 секунд)
- **Фоновая задача**: работает параллельно с основным ботом в отдельном asyncio task
- **Логика**: проверяет список пользователей и сравнивает текущее время (МСК) со списком времен напоминаний

### Типы напоминаний

Система использует **6 различных типов промптов** для разнообразия напоминаний. При каждой отправке выбирается случайный тип:

1. **interests** - Вопросы об интересах (что читает/смотрит)
2. **situational** - Ситуативные вопросы (как проходит понедельник/выходной)
3. **humor** - Юмор и интересные факты
4. **how_are_you** - Как дела, что нового
5. **compliment** - Комплименты и похвалы
6. **plans** - Вопросы о планах на будущее (на день, неделю, долгосрочные цели)

Каждый промпт учитывает:
- **Контекст** предыдущих разговоров
- **Текущую дату и время**
- **День недели** (для ситуативных промптов)
- **Имя пользователя** (если доступно)

### Времена напоминаний

Каждый пользователь имеет поле `reminder_times` - список времен в формате `HH:MM` (МСК).

**По умолчанию**: `["19:15"]`

### Предотвращение дублей

Чтобы избежать отправки нескольких напоминаний в течение одного периода:
- После отправки напоминания обновляется поле `remind_of_yourself` на текущее время
- При проверке система проверяет, что последнее напоминание было отправлено более часа назад
- Если время напоминания попадает в окно 15 минут (0-14 минут после заданного времени)

## Админские команды

### `/set_reminder_times`

Установка времен напоминаний для конкретного пользователя.

**Использование**:
1. Найдите сообщение, содержащее `USER{id}` (например, из логов или статистики)
2. Ответьте на это сообщение командой `/set_reminder_times`
3. Введите времена в формате МСК через пробел

**Примеры**:
```
09:00 14:30 19:15
```
```
10:00 18:00
```
```
12:00
```

**Особенности**:
- Можно указать одно или несколько времен
- Времена автоматически валидируются (проверка диапазонов 0-23 для часов, 0-59 для минут)
- Дубликаты автоматически удаляются
- Времена форматируются с ведущими нулями (например, `9:5` → `09:05`)

### Где работает команда

Команда работает в дебаг-чате, где все пользователи являются админами.

## База данных

### Миграция

Миграция `migration_003_add_reminder_times.py` добавляет поле `reminder_times` в таблицу `users`:
- **Тип**: TEXT (JSON массив)
- **По умолчанию**: `["19:15"]`
- **Применяется автоматически** при запуске бота

### Структура данных

```json
["09:00", "14:30", "19:15"]
```

## Отключение напоминаний

Чтобы отключить напоминания для пользователя:
- Установите поле `remind_of_yourself` в значение `"0"`
- Пользователь будет пропущен при проверке

## Логи

При отправке напоминания в логах появляется тип использованного промпта:
```
USER{user_id} - Выбран тип напоминания: situational
LLM{user_id}REMINDER_SITUATIONAL - {текст сообщения}
```

Другие типы в логах: `REMINDER_INTERESTS`, `REMINDER_HUMOR`, `REMINDER_HOW_ARE_YOU`, `REMINDER_COMPLIMENT`, `REMINDER_PLANS`

При обновлении времен напоминаний:
```
✅ Времена напоминаний для USER{user_id} обновлены: 09:00, 14:30, 19:15
```

## Пример работы

1. У пользователя установлены времена: `["09:00", "19:15"]`
2. В 09:05 МСК фоновая задача проверяет пользователей
3. Находит, что 09:00 попадает в окно (09:05 - 09:00 = 5 минут < 15)
4. Проверяет, что последнее напоминание было > 1 часа назад
5. **Выбирает случайный тип напоминания** (например, "situational")
6. Формирует промпт с учетом дня недели ("Понедельник")
7. Отправляет запрос к LLM с выбранным промптом
8. Отправляет ответ модели пользователю
9. Обновляет `remind_of_yourself` на текущее время (09:05)
10. Следующее напоминание будет в 19:15 с другим случайным типом

## Технические детали

### Файлы

- `migrations/migration_003_add_reminder_times.py` - миграция БД
- `database.py` - класс User с поддержкой `reminder_times`
- `services/reminder_service.py` - фоновая задача и логика отправки
- `handlers/admin_handlers.py` - команда `/set_reminder_times`
- `states.py` - FSM состояния для команды

### Часовой пояс

Все времена работают в **МСК (UTC+3)**, настраивается через переменную окружения `TIMEZONE_OFFSET=3`.

