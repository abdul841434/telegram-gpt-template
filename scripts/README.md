# Скрипты для работы с ботом

Набор утилит для управления базой данных и другими компонентами бота.

## Список скриптов

### `add_user.sh`

Скрипт для ручного добавления пользователей и групповых чатов в базу данных.

### `test_model.py`

Скрипт для тестирования доступности моделей через OpenRouter API.

**Использование:**

```bash
# Из корня проекта
python scripts/test_model.py

# Или напрямую (если есть права на исполнение)
./scripts/test_model.py
```

**Что делает:**
1. Работает в бесконечном цикле, позволяя тестировать несколько моделей подряд
2. Запрашивает название модели через input()
3. Отправляет тестовый запрос к модели через OpenRouter API
4. Выводит ответ модели при успехе или описание ошибки при неудаче
5. Для выхода нужно ввести `exit`

**Примеры моделей:**
- `deepseek/deepseek-chat` - DeepSeek Chat
- `anthropic/claude-3.5-sonnet` - Claude 3.5 Sonnet
- `openai/gpt-4o` - GPT-4o
- `google/gemini-2.0-flash-001` - Gemini 2.0 Flash
- `meta-llama/llama-3.1-70b-instruct` - Llama 3.1 70B

**Примечания:**
- Требует наличия `LLM_TOKEN` в `.env` файле
- Использует тот же подход к работе с API, что и основной код бота
- Полезен для проверки доступности моделей из РФ

---

**Использование:**

```bash
# Добавить личного пользователя
./add_user.sh USER7581829366
./add_user.sh 7581829366

# Добавить групповой чат
./add_user.sh USER-1003209384984
./add_user.sh -1003209384984
```

**Параметры по умолчанию:**
- `name`: NULL (автоматически обновится при первом сообщении)
- `remind_of_yourself`: NULL (напоминания **включены**)
- `reminder_time`: "19:15" (стандартное время напоминаний МСК)
- `reminder_weekdays`: "[]" (все дни недели, пустой список = все дни)
- `sub_lvl`: 0 (нет подписки)
- `is_admin`: 0 (не администратор)

**Что делает:**
1. Проверяет формат ID (поддерживает отрицательные ID для чатов)
2. Проверяет существование пользователя/чата в базе
3. Если не существует - добавляет с базовыми параметрами
4. Выводит статус операции

**Примечания:**
- Имя пользователя/чата обновится автоматически из Telegram при первом сообщении
- Напоминания включены по умолчанию (отправка в 19:15 МСК)
- Пользователь может отключить напоминания командой `/mute`

---

## Прямые SQL запросы

Если нужно работать напрямую с базой:

```bash
# Подключение к базе
sqlite3 users.db

# Или из папки scripts/
sqlite3 ../users.db
```

### Полезные запросы:

```sql
-- Количество пользователей
SELECT COUNT(*) FROM conversations;

-- Только личные пользователи (ID > 0)
SELECT COUNT(*) FROM conversations WHERE id > 0;

-- Только групповые чаты (ID < 0)
SELECT COUNT(*) FROM conversations WHERE id < 0;

-- Список всех пользователей с именами
SELECT id, name, remind_of_yourself FROM conversations;

-- Проверить конкретного пользователя
SELECT * FROM conversations WHERE id = 7581829366;

-- Добавить пользователя вручную
INSERT INTO conversations (id, name, prompt, remind_of_yourself, sub_lvl, sub_id, sub_period, is_admin, reminder_time, reminder_weekdays)
VALUES (7581829366, NULL, '[]', NULL, 0, 0, -1, 0, '19:15', '[]');

-- Удалить пользователя
DELETE FROM conversations WHERE id = 7581829366;
DELETE FROM messages WHERE user_id = 7581829366;
```

---

## Структура базы данных

### Таблица `conversations`

Основная таблица с информацией о пользователях и чатах:

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | INTEGER | ID пользователя (>0) или чата (<0) |
| `name` | TEXT | Имя пользователя или название чата |
| `prompt` | JSON | Список промптов (deprecated) |
| `remind_of_yourself` | TEXT | NULL = включено, "0" = отключено, timestamp = последняя отправка |
| `sub_lvl` | INTEGER | Уровень подписки |
| `sub_id` | TEXT | ID подписки |
| `sub_period` | INTEGER | Период подписки |
| `is_admin` | INTEGER | Флаг администратора |
| `active_messages_count` | INTEGER | Количество активных сообщений в контексте |
| `reminder_time` | TEXT | Время напоминания в формате "HH:MM" (МСК) |
| `reminder_weekdays` | TEXT | JSON массив дней недели [0-6], пустой [] = все дни |
| `subscription_verified` | INTEGER | Статус верификации подписки на каналы |

### Таблица `messages`

История сообщений:

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | INTEGER | Уникальный ID сообщения |
| `user_id` | INTEGER | ID пользователя/чата |
| `role` | TEXT | Роль (user/assistant) |
| `content` | TEXT | Содержимое сообщения |
| `timestamp` | TEXT | Время отправки |

### Таблица `chat_verifications`

Верификация групповых чатов:

| Поле | Тип | Описание |
|------|-----|----------|
| `chat_id` | INTEGER | ID чата (отрицательный) |
| `verified_by_user_id` | INTEGER | ID пользователя, подтвердившего подписку |
| `verified_at` | TEXT | Дата верификации |
| `user_name` | TEXT | Имя верификатора |

---

## Добавление новых скриптов

При создании новых скриптов:

1. Добавляйте подробный комментарий в начале файла
2. Используйте относительные пути к базе данных
3. Добавляйте проверки на существование файлов/записей
4. Выводите понятные сообщения об ошибках
5. Обновляйте этот README
6. Делайте скрипт исполняемым: `chmod +x script_name.sh`

**Пример заголовка:**

```bash
#!/bin/bash
# Краткое описание скрипта
# Использование: ./script_name.sh [аргументы]
```

