#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —á–∞—Ç–æ–≤ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./add_user.sh USER7581829366 –∏–ª–∏ ./add_user.sh -1003209384984

USER_ID=$1

if [ -z "$USER_ID" ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./add_user.sh USER7581829366"
    echo "              –∏–ª–∏: ./add_user.sh 7581829366"
    echo "              –∏–ª–∏: ./add_user.sh USER-1003209384984 (–¥–ª—è —á–∞—Ç–æ–≤)"
    exit 1
fi

# –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å USER –µ—Å–ª–∏ –µ—Å—Ç—å
USER_ID=${USER_ID#USER}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ —á–∏—Å–ª–æ (–≤–∫–ª—é—á–∞—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –¥–ª—è —á–∞—Ç–æ–≤)
if ! [[ "$USER_ID" =~ ^-?[0-9]+$ ]]; then
    echo "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID: $USER_ID"
    exit 1
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø
if [ "$USER_ID" -lt 0 ]; then
    TYPE="CHAT"
else
    TYPE="USER"
fi

# –ü—É—Ç—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞)
DB_PATH="../users.db"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã
if [ ! -f "$DB_PATH" ]; then
    echo "‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $DB_PATH"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ
EXISTS=$(sqlite3 "$DB_PATH" "SELECT EXISTS(SELECT 1 FROM conversations WHERE id = $USER_ID);")

if [ "$EXISTS" -eq 1 ]; then
    echo "‚ÑπÔ∏è  $TYPE$USER_ID —É–∂–µ –µ—Å—Ç—å –≤ –±–∞–∑–µ"
else
    # –î–æ–±–∞–≤–ª—è–µ–º —Å:
    # - name = NULL (–æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
    # - remind_of_yourself = NULL (–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –í–ö–õ–Æ–ß–ï–ù–´ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    # - reminder_time = "19:15" (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –≤—Ä–µ–º—è)
    # - reminder_weekdays = "[]" (–≤—Å–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏)
    sqlite3 "$DB_PATH" "INSERT INTO conversations (id, name, prompt, remind_of_yourself, sub_lvl, sub_id, sub_period, is_admin, reminder_time, reminder_weekdays) VALUES ($USER_ID, NULL, '[]', NULL, 0, 0, -1, 0, '19:15', '[]');"
    echo "‚úÖ $TYPE$USER_ID –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É"
    echo "   üìù –ò–º—è –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏"
    echo "   üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –í–ö–õ–Æ–ß–ï–ù–´ (–≤—Ä–µ–º—è: 19:15 –ú–°–ö)"
fi

